// Generated by CoffeeScript 1.9.1
var exe, exec, handlers, index, merge, options, ref, run, spawn,
  slice = [].slice;

require("source-map-support").install();

ref = require("child_process"), exec = ref.exec, spawn = ref.spawn;

merge = require("lodash.merge");

options = require("./options");

exe = function(cmd, opts, cb) {
  return exec(cmd, opts, function(err, stdout, stderr) {
    if (stderr) {
      process.stderr.write(stderr);
    }
    if (err !== null) {
      return console.trace(JSON.stringify(err, null, 2));
    } else if (cb != null) {
      return cb(stdout);
    } else {
      return process.stdout.write(stdout);
    }
  });
};

handlers = function(opts) {
  var defaults;
  defaults = {
    stdout: function(data) {
      return process.stdout.write(data);
    },
    stderr: function(data) {
      return process.stderr.write(data);
    },
    error: function(err, context) {
      return console.trace(JSON.stringify(err, null, 2));
    },
    close: function(code, context) {
      if (code !== 0) {
        return console.log("This `" + context.cmd + "` process exited with " + code + ".");
      }
    }
  };
  if (opts != null) {
    return merge({}, defaults, opts);
  } else {
    return defaults;
  }
};

run = function(cmd, opts) {
  var chips, cmdArgs, command, context, handles;
  if (opts == null) {
    opts = {};
  }
  if (typeof cmd !== "string") {
    console.log("Expecting command string, instead got:");
    console.log(cmd);
    throw new Error("Wrong command type: '" + (typeof cmd) + "'.");
  }
  cmdArgs = cmd.split(/\s+/);
  command = cmdArgs.shift();
  handles = handlers(opts.childish);
  context = {
    "cmd": cmd
  };
  chips = spawn(command, cmdArgs, opts);
  chips.stdout.on("data", function(data) {
    return handles.stdout(data);
  });
  chips.stderr.on("data", function(data) {
    return handles.stderr(data);
  });
  chips.on("error", function(err) {
    return handles.error(err, context);
  });
  return chips.on("close", function(code) {
    return handles.close(code, context);
  });
};

index = function() {
  var args, cmd, n;
  cmd = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
  n = args.length;
  if (n > 0) {
    if (typeof args[n - 1] === "function") {
      if (n === 1) {
        return exe(cmd, {}, args[0]);
      } else {
        return exe(cmd, args[0], args[n - 1]);
      }
    } else {
      if (args[0].childish != null) {
        args[0].childish = options(args[0].childish);
      }
      return run(cmd, args[0]);
    }
  } else {
    return run(cmd);
  }
};

module.exports = function() {
  var rest, what;
  what = arguments[0], rest = 2 <= arguments.length ? slice.call(arguments, 1) : [];
  if (arguments.length === 1 && typeof what === "object") {
    return function() {
      var args, cmd;
      cmd = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      if (args.length) {
        if (typeof args[args.length - 1] === "function") {
          return index.apply(null, arguments);
        } else {
          return index.call(null, cmd, merge({}, what, args[0]));
        }
      } else {
        return index.call(null, cmd);
      }
    };
  } else {
    return index.apply(null, arguments);
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguY29mZmVlIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW5kZXguY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFBLDJEQUFBO0VBQUEsZ0JBQUE7O0FBQUEsT0FBQSxDQUFRLG9CQUFSLENBQTZCLENBQUMsT0FBOUIsQ0FBQSxDQUFBLENBQUE7O0FBQUEsTUFFZ0IsT0FBQSxDQUFRLGVBQVIsQ0FBaEIsRUFBQyxXQUFBLElBQUQsRUFBTyxZQUFBLEtBRlAsQ0FBQTs7QUFBQSxLQUdBLEdBQVEsT0FBQSxDQUFRLGNBQVIsQ0FIUixDQUFBOztBQUFBLE9BSUEsR0FBVSxPQUFBLENBQVEsV0FBUixDQUpWLENBQUE7O0FBQUEsR0FPQSxHQUFNLFNBQUMsR0FBRCxFQUFNLElBQU4sRUFBWSxFQUFaLEdBQUE7U0FDSixJQUFBLENBQUssR0FBTCxFQUFVLElBQVYsRUFBZ0IsU0FBQyxHQUFELEVBQU0sTUFBTixFQUFjLE1BQWQsR0FBQTtBQUNkLElBQUEsSUFBZ0MsTUFBaEM7QUFBQSxNQUFBLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBZixDQUFxQixNQUFyQixDQUFBLENBQUE7S0FBQTtBQUNBLElBQUEsSUFBRyxHQUFBLEtBQVMsSUFBWjthQUNFLE9BQU8sQ0FBQyxLQUFSLENBQWMsSUFBSSxDQUFDLFNBQUwsQ0FBZSxHQUFmLEVBQW9CLElBQXBCLEVBQTBCLENBQTFCLENBQWQsRUFERjtLQUFBLE1BRUssSUFBRyxVQUFIO2FBQ0gsRUFBQSxDQUFHLE1BQUgsRUFERztLQUFBLE1BQUE7YUFHSCxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQWYsQ0FBcUIsTUFBckIsRUFIRztLQUpTO0VBQUEsQ0FBaEIsRUFESTtBQUFBLENBUE4sQ0FBQTs7QUFBQSxRQWtCQSxHQUFXLFNBQUMsSUFBRCxHQUFBO0FBQ1QsTUFBQSxRQUFBO0FBQUEsRUFBQSxRQUFBLEdBQ0U7QUFBQSxJQUFBLE1BQUEsRUFBUSxTQUFDLElBQUQsR0FBQTthQUFVLE9B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QUssQ0FBQyxJQUFOLENBQVcsSUFBWCxFQUFpQixHQUFqQixFQUFzQixLQUFBLENBQU0sRUFBTixFQUFVLElBQVYsRUFBZ0IsSUFBSyxDQUFBLENBQUEsQ0FBckIsQ0FBdEIsRUFORjtTQURGO09BQUEsTUFBQTtlQVVFLEtBQUssQ0FBQyxJQUFOLENBQVcsSUFBWCxFQUFpQixHQUFqQixFQVZGO09BREs7SUFBQSxDQUFQLENBREY7R0FBQSxNQUFBO1dBY0UsS0FBSyxDQUFDLEtBQU4sQ0FBWSxJQUFaLEVBQWtCLFNBQWxCLEVBZEY7R0FEZTtBQUFBLENBaEVqQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZShcInNvdXJjZS1tYXAtc3VwcG9ydFwiKS5pbnN0YWxsKClcblxue2V4ZWMsIHNwYXdufSA9IHJlcXVpcmUoXCJjaGlsZF9wcm9jZXNzXCIpXG5tZXJnZSA9IHJlcXVpcmUoXCJsb2Rhc2gubWVyZ2VcIilcbm9wdGlvbnMgPSByZXF1aXJlKFwiLi9vcHRpb25zXCIpXG5cbiMgZXhlYyAjc2ltcGxlXG5leGUgPSAoY21kLCBvcHRzLCBjYikgLT5cbiAgZXhlYyBjbWQsIG9wdHMsIChlcnIsIHN0ZG91dCwgc3RkZXJyKSAtPlxuICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKHN0ZGVycikgaWYgc3RkZXJyXG4gICAgaWYgZXJyIGlzbnQgbnVsbFxuICAgICAgY29uc29sZS50cmFjZSBKU09OLnN0cmluZ2lmeShlcnIsIG51bGwsIDIpXG4gICAgZWxzZSBpZiBjYj9cbiAgICAgIGNiKHN0ZG91dClcbiAgICBlbHNlXG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShzdGRvdXQpXG5cbiMgZXZlbnQtaGFuZGxlciBkZWZhdWx0cyAvIG92ZXJyaWRlc1xuaGFuZGxlcnMgPSAob3B0cykgLT5cbiAgZGVmYXVsdHMgPVxuICAgIHN0ZG91dDogKGRhdGEpIC0+IHByb2Nlc3Muc3Rkb3V0LndyaXRlKGRhdGEpXG4gICAgc3RkZXJyOiAoZGF0YSkgLT4gcHJvY2Vzcy5zdGRlcnIud3JpdGUoZGF0YSlcbiAgICBlcnJvcjogKGVyciwgY29udGV4dCkgLT4gY29uc29sZS50cmFjZSBKU09OLnN0cmluZ2lmeShlcnIsIG51bGwsIDIpXG4gICAgY2xvc2U6IChjb2RlLCBjb250ZXh0KSAtPlxuICAgICAgdW5sZXNzIGNvZGUgaXMgMFxuICAgICAgICBjb25zb2xlLmxvZyBcIlRoaXMgYCN7Y29udGV4dC5jbWR9YCBwcm9jZXNzIGV4aXRlZCB3aXRoICN7Y29kZX0uXCJcbiAgaWYgb3B0cz9cbiAgICBtZXJnZSh7fSwgZGVmYXVsdHMsIG9wdHMpXG4gIGVsc2VcbiAgICBkZWZhdWx0c1xuXG4jIHNwYXduICNzaW1wbGVcbnJ1biA9IChjbWQsIG9wdHMgPSB7fSkgLT5cbiAgdW5sZXNzIHR5cGVvZiBjbWQgaXMgXCJzdHJpbmdcIlxuICAgIGNvbnNvbGUubG9nIFwiRXhwZWN0aW5nIGNvbW1hbmQgc3RyaW5nLCBpbnN0ZWFkIGdvdDpcIlxuICAgIGNvbnNvbGUubG9nIGNtZFxuICAgIHRocm93IG5ldyBFcnJvciBcIldyb25nIGNvbW1hbmQgdHlwZTogJyN7dHlwZW9mIGNtZH0nLlwiXG4gIGNtZEFyZ3MgPSBjbWQuc3BsaXQgL1xccysvXG4gIGNvbW1hbmQgPSBjbWRBcmdzLnNoaWZ0KClcbiAgaGFuZGxlcyA9IGhhbmRsZXJzKG9wdHMuY2hpbGRpc2gpXG4gIGNvbnRleHQgPSBcImNtZFwiOiBjbWRcbiAgY2hpcHMgPSBzcGF3bihjb21tYW5kLCBjbWRBcmdzLCBvcHRzKVxuICBjaGlwcy5zdGRvdXQub24gXCJkYXRhXCIsIChkYXRhKSAtPiBoYW5kbGVzLnN0ZG91dChkYXRhKVxuICBjaGlwcy5zdGRlcnIub24gXCJkYXRhXCIsIChkYXRhKSAtPiBoYW5kbGVzLnN0ZGVycihkYXRhKVxuICBjaGlwcy5vbiBcImVycm9yXCIsIChlcnIpIC0+IGhhbmRsZXMuZXJyb3IoZXJyLCBjb250ZXh0KVxuICBjaGlwcy5vbiBcImNsb3NlXCIsIChjb2RlKSAtPiBoYW5kbGVzLmNsb3NlKGNvZGUsIGNvbnRleHQpXG5cbmluZGV4ID0gKGNtZCwgYXJncy4uLikgLT5cbiAgbiA9IGFyZ3MubGVuZ3RoXG4gIGlmIG4gPiAwXG4gICAgaWYgdHlwZW9mIGFyZ3NbbiAtIDFdIGlzIFwiZnVuY3Rpb25cIlxuICAgICAgaWYgbiBpcyAxXG4gICAgICAgIGV4ZSBjbWQsIHt9LCBhcmdzWzBdXG4gICAgICBlbHNlXG4gICAgICAgICMgZXhlIHRha2VzIGF0IG1vc3QgMyBhcmd1bWVudHMgKGhlcmUgdXNpbmcgdGhlIGZpcnN0ICYgbGFzdCBvZiBhcmdzKVxuICAgICAgICBleGUgY21kLCBhcmdzWzBdLCBhcmdzW24gLSAxXVxuICAgIGVsc2VcbiAgICAgICMgcnVuIHRha2VzIGF0IG1vc3QgMiBhcmd1bWVudHMsIHRoZSAybmQsIG9wdGlvbnMsIGNvdWxkIGNvbnRhaW4gY2hpbGRpc2hcbiAgICAgIGlmIGFyZ3NbMF0uY2hpbGRpc2g/XG4gICAgICAgIGFyZ3NbMF0uY2hpbGRpc2ggPSBvcHRpb25zKGFyZ3NbMF0uY2hpbGRpc2gpICMgc3BlY2lhbCBjaGlsZGlzaCBvcHRpb25zXG4gICAgICBydW4gY21kLCBhcmdzWzBdXG4gIGVsc2VcbiAgICBydW4gY21kXG5cbm1vZHVsZS5leHBvcnRzID0gKHdoYXQsIHJlc3QuLi4pIC0+XG4gIGlmIGFyZ3VtZW50cy5sZW5ndGggaXMgMSBhbmQgdHlwZW9mIHdoYXQgaXMgXCJvYmplY3RcIlxuICAgIHJldHVybiAoY21kLCBhcmdzLi4uKSAtPlxuICAgICAgaWYgYXJncy5sZW5ndGhcbiAgICAgICAgaWYgdHlwZW9mIGFyZ3NbYXJncy5sZW5ndGggLSAxXSBpcyBcImZ1bmN0aW9uXCJcbiAgICAgICAgICAjIE5PVEU6IGV4ZWMgaWdub3JlcyBkZWZhdWx0IG9wdGlvbnMgZm9yIG5vdyxcbiAgICAgICAgICAjIGFzIGl0IGRvZXNuJ3QgbmVlZCB0aGVtIGxpa2Ugc3Bhd24gKG1vcmUgdXNlZnVsIGFuZCBmYXZvcmVkKS5cbiAgICAgICAgICAjIFRyZWF0aW5nIHRoaXMgYXMgX1lBR05JXywgdGhvdWdoIGl0IG1heSBiZSBlYXN5IHRvIGltcGxlbWVudC4uLlxuICAgICAgICAgIGluZGV4LmFwcGx5IG51bGwsIGFyZ3VtZW50c1xuICAgICAgICBlbHNlXG4gICAgICAgICAgaW5kZXguY2FsbCBudWxsLCBjbWQsIG1lcmdlKHt9LCB3aGF0LCBhcmdzWzBdKVxuICAgICAgZWxzZVxuICAgICAgICAjIHNwYXduIHdpdGggbm8gb3B0aW9ucyAtIGV4Y2VwdCBgd2hhdGAtZXZlciBkZWZhdWx0c1xuICAgICAgICBpbmRleC5jYWxsIG51bGwsIGNtZFxuICBlbHNlXG4gICAgaW5kZXguYXBwbHkgbnVsbCwgYXJndW1lbnRzXG4iXX0=