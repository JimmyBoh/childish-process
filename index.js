var exe, exec, handlers, index, merge, options, ref, run, spawn,
  slice = [].slice;

require("source-map-support").install();

ref = require("child_process"), exec = ref.exec, spawn = ref.spawn;

merge = require("lodash.merge");

options = require("./options");

exe = function(cmd, opts, cb) {
  return exec(cmd, opts, function(err, stdout, stderr) {
    if (stderr) {
      process.stderr.write(stderr);
    }
    if (err !== null) {
      return console.trace(JSON.stringify(err, null, 2));
    } else if (cb != null) {
      return cb(stdout);
    } else {
      return process.stdout.write(stdout);
    }
  });
};

handlers = function(opts) {
  var defaults;
  defaults = {
    stdout: function(data) {
      return process.stdout.write(data);
    },
    stderr: function(data) {
      return process.stderr.write(data);
    },
    error: function(err, context) {
      return console.trace(JSON.stringify(err, null, 2));
    },
    close: function(code, context) {
      if (code !== 0) {
        return console.log("This `" + context.cmd + "` process exited with " + code + ".");
      }
    }
  };
  if (opts != null) {
    return merge({}, defaults, opts);
  } else {
    return defaults;
  }
};

run = function(cmd, opts) {
  var args, chips, command, context, handles;
  if (opts == null) {
    opts = {};
  }
  args = cmd.split(/\s+/);
  command = args.shift();
  handles = handlers(opts.childish);
  context = {
    "cmd": cmd
  };
  chips = spawn(command, args, opts);
  chips.stdout.on("data", function(data) {
    return handles.stdout(data);
  });
  chips.stderr.on("data", function(data) {
    return handles.stderr(data);
  });
  chips.on("error", function(err) {
    return handles.error(err, context);
  });
  return chips.on("close", function(code) {
    return handles.close(code, context);
  });
};

index = function() {
  var args, cmd, n;
  cmd = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
  n = args.length;
  if (n > 0) {
    if (typeof args[n - 1] === "function") {
      if (n === 1) {
        return exe(cmd, {}, args[0]);
      } else {
        return exe(cmd, args[0], args[n - 1]);
      }
    } else {
      if (args[0].childish != null) {
        args[0].childish = options(args[0].childish);
      }
      return run(cmd, args[0]);
    }
  } else {
    return run(cmd);
  }
};

module.exports = function() {
  var rest, what;
  what = arguments[0], rest = 2 <= arguments.length ? slice.call(arguments, 1) : [];
  if (arguments.length === 1 && typeof what === "object") {
    return function() {
      var args, cmd;
      cmd = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      if (args.length) {
        if (typeof args[args.length - 1] === "function") {
          return index.apply(null, arguments);
        } else {
          return index.call(null, cmd, merge({}, what, args[0]));
        }
      } else {
        return index.apply(null, arguments);
      }
    };
  } else {
    return index.apply(null, arguments);
  }
};

//# sourceMappingURL=data:application/json;base64,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QUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZShcInNvdXJjZS1tYXAtc3VwcG9ydFwiKS5pbnN0YWxsKClcblxue2V4ZWMsIHNwYXdufSA9IHJlcXVpcmUoXCJjaGlsZF9wcm9jZXNzXCIpXG5tZXJnZSA9IHJlcXVpcmUoXCJsb2Rhc2gubWVyZ2VcIilcbm9wdGlvbnMgPSByZXF1aXJlKFwiLi9vcHRpb25zXCIpXG5cbiMgZXhlYyAjc2ltcGxlXG5leGUgPSAoY21kLCBvcHRzLCBjYikgLT5cbiAgZXhlYyBjbWQsIG9wdHMsIChlcnIsIHN0ZG91dCwgc3RkZXJyKSAtPlxuICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKHN0ZGVycikgaWYgc3RkZXJyXG4gICAgaWYgZXJyIGlzbnQgbnVsbFxuICAgICAgY29uc29sZS50cmFjZSBKU09OLnN0cmluZ2lmeShlcnIsIG51bGwsIDIpXG4gICAgZWxzZSBpZiBjYj9cbiAgICAgIGNiKHN0ZG91dClcbiAgICBlbHNlXG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShzdGRvdXQpXG5cbiMgZXZlbnQtaGFuZGxlciBkZWZhdWx0cyAvIG92ZXJyaWRlc1xuaGFuZGxlcnMgPSAob3B0cykgLT5cbiAgZGVmYXVsdHMgPVxuICAgIHN0ZG91dDogKGRhdGEpIC0+IHByb2Nlc3Muc3Rkb3V0LndyaXRlKGRhdGEpXG4gICAgc3RkZXJyOiAoZGF0YSkgLT4gcHJvY2Vzcy5zdGRlcnIud3JpdGUoZGF0YSlcbiAgICBlcnJvcjogKGVyciwgY29udGV4dCkgLT4gY29uc29sZS50cmFjZSBKU09OLnN0cmluZ2lmeShlcnIsIG51bGwsIDIpXG4gICAgY2xvc2U6IChjb2RlLCBjb250ZXh0KSAtPlxuICAgICAgdW5sZXNzIGNvZGUgaXMgMFxuICAgICAgICBjb25zb2xlLmxvZyBcIlRoaXMgYCN7Y29udGV4dC5jbWR9YCBwcm9jZXNzIGV4aXRlZCB3aXRoICN7Y29kZX0uXCJcbiAgaWYgb3B0cz9cbiAgICBtZXJnZSh7fSwgZGVmYXVsdHMsIG9wdHMpXG4gIGVsc2VcbiAgICBkZWZhdWx0c1xuXG4jIHNwYXduICNzaW1wbGVcbnJ1biA9IChjbWQsIG9wdHMgPSB7fSkgLT5cbiAgYXJncyA9IGNtZC5zcGxpdCAvXFxzKy9cbiAgY29tbWFuZCA9IGFyZ3Muc2hpZnQoKVxuICBoYW5kbGVzID0gaGFuZGxlcnMob3B0cy5jaGlsZGlzaClcbiAgY29udGV4dCA9IFwiY21kXCI6IGNtZFxuICBjaGlwcyA9IHNwYXduKGNvbW1hbmQsIGFyZ3MsIG9wdHMpXG4gIGNoaXBzLnN0ZG91dC5vbiBcImRhdGFcIiwgKGRhdGEpIC0+IGhhbmRsZXMuc3Rkb3V0KGRhdGEpXG4gIGNoaXBzLnN0ZGVyci5vbiBcImRhdGFcIiwgKGRhdGEpIC0+IGhhbmRsZXMuc3RkZXJyKGRhdGEpXG4gIGNoaXBzLm9uIFwiZXJyb3JcIiwgKGVycikgLT4gaGFuZGxlcy5lcnJvcihlcnIsIGNvbnRleHQpXG4gIGNoaXBzLm9uIFwiY2xvc2VcIiwgKGNvZGUpIC0+IGhhbmRsZXMuY2xvc2UoY29kZSwgY29udGV4dClcblxuaW5kZXggPSAoY21kLCBhcmdzLi4uKSAtPlxuICBuID0gYXJncy5sZW5ndGhcbiAgaWYgbiA+IDBcbiAgICBpZiB0eXBlb2YgYXJnc1tuIC0gMV0gaXMgXCJmdW5jdGlvblwiXG4gICAgICBpZiBuIGlzIDFcbiAgICAgICAgZXhlIGNtZCwge30sIGFyZ3NbMF1cbiAgICAgIGVsc2VcbiAgICAgICAgIyBleGUgdGFrZXMgYXQgbW9zdCAzIGFyZ3VtZW50cyAoaGVyZSB1c2luZyB0aGUgZmlyc3QgJiBsYXN0IG9mIGFyZ3MpXG4gICAgICAgIGV4ZSBjbWQsIGFyZ3NbMF0sIGFyZ3NbbiAtIDFdXG4gICAgZWxzZVxuICAgICAgIyBydW4gdGFrZXMgYXQgbW9zdCAyIGFyZ3VtZW50cywgdGhlIDJuZCwgb3B0aW9ucywgY291bGQgY29udGFpbiBjaGlsZGlzaFxuICAgICAgaWYgYXJnc1swXS5jaGlsZGlzaD9cbiAgICAgICAgYXJnc1swXS5jaGlsZGlzaCA9IG9wdGlvbnMoYXJnc1swXS5jaGlsZGlzaCkgIyBzcGVjaWFsIGNoaWxkaXNoIG9wdGlvbnNcbiAgICAgIHJ1biBjbWQsIGFyZ3NbMF1cbiAgZWxzZVxuICAgIHJ1biBjbWRcblxubW9kdWxlLmV4cG9ydHMgPSAod2hhdCwgcmVzdC4uLikgLT5cbiAgaWYgYXJndW1lbnRzLmxlbmd0aCBpcyAxIGFuZCB0eXBlb2Ygd2hhdCBpcyBcIm9iamVjdFwiXG4gICAgcmV0dXJuIChjbWQsIGFyZ3MuLi4pIC0+XG4gICAgICBpZiBhcmdzLmxlbmd0aFxuICAgICAgICBpZiB0eXBlb2YgYXJnc1thcmdzLmxlbmd0aCAtIDFdIGlzIFwiZnVuY3Rpb25cIlxuICAgICAgICAgICMgTk9URTogZXhlYyBpZ25vcmVzIGRlZmF1bHQgb3B0aW9ucyBmb3Igbm93LFxuICAgICAgICAgICMgYXMgaXQgZG9lc24ndCBuZWVkIHRoZW0gbGlrZSBzcGF3biAobW9yZSB1c2VmdWwgYW5kIGZhdm9yZWQpLlxuICAgICAgICAgICMgVHJlYXRpbmcgdGhpcyBhcyBfWUFHTklfLCB0aG91Z2ggaXQgbWF5IGJlIGVhc3kgdG8gaW1wbGVtZW50Li4uXG4gICAgICAgICAgaW5kZXguYXBwbHkgbnVsbCwgYXJndW1lbnRzXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBpbmRleC5jYWxsIG51bGwsIGNtZCwgbWVyZ2Uoe30sIHdoYXQsIGFyZ3NbMF0pXG4gICAgICBlbHNlXG4gICAgICAgICMgc3Bhd24gd2l0aCBubyBvcHRpb25zIC0gZXhjZXB0IGB3aGF0YC1ldmVyIGRlZmF1bHRzXG4gICAgICAgIGluZGV4LmFwcGx5IG51bGwsIGFyZ3VtZW50c1xuICBlbHNlXG4gICAgaW5kZXguYXBwbHkgbnVsbCwgYXJndW1lbnRzXG4iXX0=